## 系统诊断与任务诊断

用户在使用 Kyligence Enterprise 过程中可能会遇到各类问题，例如 Cube 构建失败、SQL 查询失败、SQL 查询时间过长等。为了帮助高效解决这些问题，Kyligence Enterprise 提供了诊断包功能，可以将有关的日志信息打包成压缩包，供运维人员或 Kyligence 技术支持分析问题原因。

该功能包含了两部分：系统诊断和任务诊断，并分别提供了两种使用方式：

### 通过网页生成诊断包 

- 生成系统诊断包
  系统诊断包包含整个 Kyligence Enterprise 实例的诊断信息，生成系统诊断包需要如下操作：
  1. 单击**系统**页面下的**诊断**按钮
  2. 选择时间范围
     可以选择**最近一小时**、**最近一天**、**最近三天**、**最近一个月**，或者自定义时间范围

     > **提示：** 选择的时间范围必须包含Kyligence Enterprise 发生问题的时间段。
  3. 选择诊断包
     可以选择**基础诊断包**和**全量诊断包**

     > **提示：** 选择基础诊断包将主要包含您的日志文件，元数据信息及您的环境信息。 全量诊断包将额外包括慢查询或者错误查询信息等。 一般情况下，我们推荐您选择**基础诊断包**即可 。 
  4. 选择服务器

     > **提示：** 如果 Kyligence Enterprise 部署在多节点上，需要确定发生问题的节点，并在生成系统诊断包时选择正确的服务器名字，否则有可能系统诊断包中不包含问题的有关信息。
  5. 选择将系统诊断包下载到本地或者上传到 KyBot

- 生成任务诊断包  
  任务诊断包包含某个任务的诊断信息，生成任务诊断包需要如下操作：
  1. 单击**监控**页面中某个任务，点击**操作**，展开后点击**诊断**按钮
  2. 选择服务器
  3. 选择将系统诊断包下载到本地或者上传到 KyBot

### 通过脚本生成诊断包 

- 生成系统诊断包
  执行 `$KYLIN_HOME/kybot/kybot.sh` 来生成系统诊断包，默认生成时间范围为最近三天。
  
- 生成任务诊断包
  执行 `$KYLIN_HOME/kybot/kybot.sh -jobId <jobid>` 来生成任务诊断包，其中请将 `<jobid>` 代替为实际的任务 ID 号。
  
- 诊断包存放地址
  通过脚本生成的诊断包默认会存放在 `$KYLIN_HOME/kybot_dump/` 下。


### FAQ

**Q: 如果遇到内存分配不够，导致打包失败怎么办？**

请您修改`$KYLIN_HOME/kybot/setenv.sh` 内的 *KYBOT_JVM_SETTINGS* 参数。然后重新启动 Kyligence Enterprise 并再次执行打包任务。

**Q: 如果遇到打包超时怎么办？**

请您修改 `$KYLIN_HOME/kybot/kybot-client.properties` 中的 *kybot.package.timeout.seconds* 参数。该参数默认为600秒，请您适当调大该参数后重新打包。

