## 日常运维工具

Kyligence Enterprise 提供了日常运维命令行工具，用于系统元数据/数据的检查、清理与恢复，从而保证系统处于良好的运行状态。**请务必定期在系统空闲时间运行此工具。**

日常运维工具主要负责：
- 元数据的检查、清理及修复
- 过期数据的检查与清理
- 元数据的备份

### 使用方法

Kyligence Enterprise 的日常运维工具通过以下命令行运行：

```shell
$KYLIN_HOME/bin/kylin.sh io.kyligence.kap.tool.routine.RoutineTool
```

在不加任何参数执行此命令时，它只会**检查**系统中的过期数据以及不一致的元数据，并不会执行真正的清理动作。

此命令支持标准的短参数和长参数，参数说明如下：

- `-c， --cleanup`：执行数据清理和删除。不带此参数时，工具不会对系统数据作任何修改。
- `-e， --excludeThreshold <arg>`：指定清理元数据时需要排除的最近元数据时间阈值（天数），`<arg>` 为整数类型值。默认为 1 天，表示最近 1 天的元数据无需执行清理。
- `-h， --help`：打印帮助信息。

> **提示**：还有一些额外的高级参数。
>
> - `-f， --force`: 强制删除 Hive 的**所有**的临时中间表，必须与 `-c` 一起使用。由于有可能干扰正在运行的任务，除非必要不建议使用 `-f`。
> - `-r， --withRecovery`: 指定这个参数来检查并修复损坏的快照，必须与 `-c` 一起使用。
> - `-o， --outdatedThreshold <arg>`: `<arg>` 为整数类型值， 指定清理时保留的构建任务以及历史记录的最大时间，默认为 30 天。
> - `-dl，--dumpLocation <arg>`: `<arg>` 为系统路径， 指定清理时导出的元数据的位置，默认为系统的临时目录。
> - `-fm，--fastMode`: 仅排查破损或不一致的元数据，跳过耗时较多的过期数据检查和清理。
> - `-stb，--singleThreadBackup`: 指定这个参数在备份元数据时启用单线程， 默认为多线程。
> - 另外，还可以在 `$KYLIN_HOME/conf/kylin.properties` 中设置参数 `kap.tool.routine-tool.delete-task-thread-num` 来启用多线程删除数据（默认为 1 即单线程）。对于一次性删除大量过期数据可以起到一定提速的作用。


### 元数据的备份

当此命令使用 `-c` 参数执行时， 在所有数据清理和修改之前，运维工具会自动备份当前系统中除了字典（dictionary），快照（snapshot），以及统计（statistics）之外的所有的元数据。当且仅当备份成功后， 才会执行清理工作。备份最多留存 5 份， 之后当有新的备份时，会将备份时间最早的文件删除。

备份文件存储路径为 `$KYLIN_HOME/meta_backups`，备份文件夹命名规范为 `meta_${timestamp}`。

### 最佳实践

对于日常的系统运维，您可以使用这一个命令行完成。我们建议您能够定期执行该命令行，来保证 Kyligence Enterprise 集群的稳定性和性能。您可以编写一个定时执行的 shell 脚本，在系统空闲时，比如每天凌晨执行。

```shell
$KYLIN_HOME/bin/kylin.sh io.kyligence.kap.tool.routine.RoutineTool -c
```

清理完毕后， 可以在 Kyligence Enterprise 的系统界面执行重载元数据操作，但这不是必须的。

**特别留意**：

1. 对于多租户部署模式，由于资源隔离， **每个租户需要独立执行该命令**。
2. 对于读写分离部署模式， 目前仅支持在**写集群**执行该工具。

